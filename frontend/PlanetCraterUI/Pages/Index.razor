@page "/"
@page "/index"

<h3>Planet Crater Detection</h3>

<InputFile OnChange="Upload" />

@if (!string.IsNullOrEmpty(Message))
{
    <p style="color:red; margin-top:10px;">@Message</p>
}

@if (ImageResult != null)
{
    <img src="@ImageResult" style="max-width:100%; margin-top:20px;" />
    <p><b>Crater Coverage:</b> @Coverage %</p>
}

@code {

    string? ImageResult;
    string? Message;
    double Coverage;

    async Task Upload(InputFileChangeEventArgs e)
    {
        Message = null;
        ImageResult = null;

        var file = e.File;

        var content = new MultipartFormDataContent();
        content.Add(
            new StreamContent(file.OpenReadStream(10_000_000)),
            "file",
            file.Name
        );

        try
        {
            var client = new HttpClient();

            var response = await client.PostAsync(
                "http://localhost:8000/detect",
                content
            );

            if (!response.IsSuccessStatusCode)
            {
                Message = $"Backend error: {response.StatusCode}";
                return;
            }

            var result = await response.Content
                .ReadFromJsonAsync<DetectionResponse>();

            if (result is null)
            {
                Message = "Empty response from server.";
                return;
            }

            if (result.success)
            {
                ImageResult = $"data:image/png;base64,{result.image_base64}";
                Coverage = result.coverage;
            }
            else
            {
                Message = result.message ?? "Detection failed.";
            }
        }
        catch (Exception)
        {
            Message = "An error occurred while processing the image.";
        }
    }

    class DetectionResponse
    {
        public bool success { get; set; }
        public double coverage { get; set; }
        public string? image_base64 { get; set; }
        public string? message { get; set; }
    }
}
